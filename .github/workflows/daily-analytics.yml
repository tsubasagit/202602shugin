name: Daily Analytics Collection

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã®ã¿ï¼ˆæ¯Žæ—¥ã®è‡ªå‹•å®Ÿè¡Œã¯å‰Šé™¤ï¼‰

jobs:
  collect-analytics:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm install @octokit/rest
      
      - name: Run analytics collection script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        run: |
          node scripts/collect-analytics.js
      
      - name: Create summary report
        run: |
          DATE=$(date +%Y-%m-%d)
          YEAR=$(date +%Y)
          MONTH=$(date +%m)
          cat > analytics-summary.md << EOF
          # ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹åŽé›†ãƒ¬ãƒãƒ¼ãƒˆ
          
          ## å®Ÿè¡Œæ—¥æ™‚
          - æ—¥ä»˜: ${DATE}
          - æ™‚åˆ»: $(date +%H:%M:%S)
          
          ## åŽé›†ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
          - ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«: \`analytics/${YEAR}/${MONTH}/analytics_${DATE}.json\`
          
          ## æ³¨æ„äº‹é …
          - ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯GitHub Actionsã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ
          - å®Ÿéš›ã®ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ã¯ã€ã‚µã‚¤ãƒˆã®localStorageã‹ã‚‰å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
          - ã‚µã‚¤ãƒˆã«ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚’æŽ¨å¥¨ã—ã¾ã™
          EOF
      
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add analytics/ analytics-summary.md
          git diff --staged --quiet || git commit -m "ðŸ“Š Daily analytics update: $(date +%Y-%m-%d)"
          git pull --rebase origin ${{ github.ref_name }}
          git push origin ${{ github.ref_name }}
